<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/451/fabric.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/vanilla-picker@2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="contain-canvas">
        <canvas id="canvas" resize></canvas>
    </div>
    <div id="control-panel">
        <h1>Input Prompt</h1>
        <form id="send-prompt">
            <input type="text" id="messageText" autocomplete="off" />
            <button>Send</button>
        </form>
        <h2 id="message"></h2>
        <div id="slider-controls">
            <div id="color-picker"></div>
            <div>
                <input type="range" id="width-slider" value="20" min="1" max="40">
                <label>Width</label>
            </div>
        </div>
        <button id="clear">Clear</button>
    </div>
    <!-- <div id="ui-overlay">
        <button id="clear">Clear</button>
    </div> -->

    <script>
        const targetHeight = 224;
        const scaleFactor = targetHeight / window.innerHeight; // scale as a square, innerHeight smaller than width

        const canvas = new fabric.Canvas("canvas", {
            width: window.innerHeight,
            height: window.innerHeight,
            backgroundColor: '#FAFAFA'
        });

        const ctx = canvas.getContext("2d");
        canvas.isDrawingMode = true;
        const brush = canvas.freeDrawingBrush;

        // Color picker
        const picker = new Picker({
            parent: document.getElementById("color-picker"),
            popup: false,
            alpha: true,
            defaultColor: '#0cf',
            editor: false,
            editorFormat: 'hex' // or 'rgb', 'hsl'
        });
        picker.onChange = (color) => {
            brush.color = color.rgbaString;
            console.log(brush)
        };
        document.getElementById("width-slider").oninput = function() {
            brush.width = parseInt(this.value, 10);
        }
        document.getElementById("clear").addEventListener("click", () => {
            canvas.clear();
        })

        // Drawing
        document.addEventListener("mouseup", () => {
            setTimeout(() => exportCanvasSvg(), 0);
            // setTimeout(() => getAllPaths(), 0);
            setTimeout(() => getLastPath(), 0);
        });

        const getLastPath = () => {
            const obj = canvas._objects[canvas._objects.length - 1];
            // console.log('last path: ', obj)
        }

        const getAllPaths = () => {
            canvas.forEachObject((i) => console.log(i));
            canvas.forEachObject((i) => console.log(i.toSVG()));
        }

        const exportCanvasSvg = () => {

            svg = scaledCanvas.toSVG();
            console.log(svg)
        }

        const readPathArray = (pathArray) => {
            for (const path in pathArray) {
                writePath(path);
            }
        }


        // const writePath = (pathString) => {
        //     var path = new fabric.Path('m 112.26316,83.842105 c 0,7.578947 0,15.157894 0,22.736845', {
        //         stroke: 'red',
        //         strokeWidth: 5,
        //         fill: false,
        //         originX: 'left',
        //         originY: 'top'
        //     });

        //     var path1 = new fabric.Path('m 74.842104,84.315788 c 0,7.578948 0,15.157895 0,22.736842', {
        //         stroke: 'red',
        //         strokeWidth: 5,
        //         fill: false,
        //         originX: 'left',
        //         originY: 'top'
        //     });

        //     var path2 = new fabric.Path('m 54.473683,133.57894 c 2.309053,6.52389 5.103384,12.88691 9.947368,18.00001 1.602465,1.69148 7.516862,3.36572 9,3.78947 8.215344,2.34724 20.231724,5.06339 28.894739,2.8421 3.21552,-0.82449 6.03091,-2.77861 9,-4.26315 8.27335,-4.13668 15.89845,-8.52099 21.31579,-16.10527', {
        //         stroke: 'red',
        //         strokeWidth: 5,
        //         fill: false,
        //         originX: 'left',
        //         originY: 'top'
        //     });

        //     var obj = fabric.util.groupSVGElements([path, path1, path2]);
        //     canvas.add(obj);
        //     obj.center();
        // }
        // writePath();

        const updatePath = () => {
            // remove specific object and redraw it. would have to maintain the index somehow. draw and generated paths would be tracked in a seperate array.
            // change or delete and redraw
        }

        const ws = new WebSocket('ws://localhost:8000/ws');
        ws.onmessage = function(event) {
            const message = document.getElementById('message');
            const {
                type,
                content
            } = JSON.parse(event.data);
            if (type === "message") {
                message.innerHTML = content
            }
            // parse stroke information
        };

        const sendMessage = (e) => {
            var input = document.getElementById("messageText")
            const msg = JSON.stringify({
                "type": "message",
                "content": input.value
            })
            ws.send(msg);
            input.value = ''
            e.preventDefault()
        }

        document.getElementById("send-prompt").addEventListener("submit", (e) => {
            sendMessage(e)
        })
    </script>
</body>

</html>