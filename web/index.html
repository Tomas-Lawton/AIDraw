<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
    <script src="https://unpkg.com/vanilla-picker@2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="contain-canvas">
        <canvas id="canvas" resize></canvas>
    </div>
    <div id="control-panel">
        <h2 id="message">Input Prompt</h2>
        <form id="send-prompt">
            <input type="text" id="messageText" />
            <button>Send</button>
        </form>
        <div id="slider-controls">
            <div id="color-picker"></div>
            <div id="prompt-input">
                <input type="range" id="width-slider" value="20" min="1" max="40">
                <label>Width</label>
            </div>
        </div>
        <button class="pen-mode" id="pen" value="pen">Pen</button>
        <button class="pen-mode" id="select" value="select">Select</button>
        <button class="pen-mode" id="erase" value="erase">Erasor</button>
        <button class="pen-mode" id="undo" value="undo">Undo</button>
        <button class="pen-mode" id="clear" value="clear">Clear</button>
    </div>

    <script>
        //     const targetHeight = 224;
        // const scaleFactor = targetHeight / window.innerHeight; // scale as a square, innerHeight smaller than width
        const canvas = document.getElementById('canvas');
        canvas.style.background = "#F4F4F4";
        paper.setup(canvas);
        let strokeColor = "#402f95";
        let strokeWidth = 20;
        let myPath;
        let penMode = "pen";

        // Drawing Controls
        document.querySelectorAll(".pen-mode").forEach(elem => {
            elem.addEventListener("click", () => {
                penMode = elem.value;
            });
        });

        const tool = new paper.Tool();
        tool.onMouseDown = function(event) {
            if (penMode === "pen") {
                myPath = new paper.Path({
                    strokeColor: strokeColor,
                    strokeWidth: strokeWidth,
                    strokeCap: 'round',
                    strokeJoin: 'round'
                });
                myPath.add(event.point);
                myPath.add({
                    ...event.point,
                    x: event.point.x + .001 //this is ok because path gets simplified
                }); //in case no drag means no line segment
                myPath.draw();
                isMoveStart = true;
            }
        }

        tool.onMouseDrag = function(event) {
            if (penMode === "pen") {
                myPath.add(event.point);
                myPath.smooth();
            }
        }

        tool.onMouseUp = function(event) {
            if (penMode === "pen") {
                myPath.simplify()
                console.log(myPath)
                console.log(paper.project.exportSVG());
                // myPath.selected = true;

                // myPath.selected = true;
                // const pathStrokes = myPath.exportSVG();
                // console.log(myPath.pathData);
                sendPaths(paper.project.exportSVG({
                    asString: true
                }));


                // console.log(paper.project.getItems()[0]._children); // is an array of paths and can get segments or pathData
                // paper.project.importSVG(svg)
                // console.log(svg)
                //draw path
                // var pathData = 'm 54.473683,133.57894 c 2.309053,6.52389 5.103384,12.88691 9.947368,18.00001 1.602465,1.69148 7.516862,3.36572 9,3.78947 8.215344,2.34724 20.231724,5.06339 28.894739,2.8421 3.21552,-0.82449 6.03091,-2.77861 9,-4.26315 8.27335,-4.13668 15.89845,-8.52099 21.31579,-16.10527';
                // var path = new paper.Path(pathData);
                // path.strokeColor = 'red';
                // path.scale(5);
            }
        }


        // Color picker
        const picker = new Picker({
            parent: document.getElementById("color-picker"),
            popup: false,
            alpha: true,
            defaultColor: '#0cf',
            editor: false,
            editorFormat: 'hex' // or 'rgb', 'hsl'
        });
        picker.setColor("#402f95");
        picker.onChange = (color) => {
            strokeColor = color.rgbaString;
        };
        document.getElementById("width-slider").oninput = function() {
            strokeWidth = parseInt(this.value, 10);
        }
        document.getElementById("clear").addEventListener("click", () => {
            paper.project.clear()
        })

        const ws = new WebSocket('ws://localhost:8000/ws');
        ws.onmessage = function(event) {
            // console.log(event)
            const message = document.getElementById('message');
            const {
                type,
                content
            } = JSON.parse(event.data);
            if (type === "message") {
                message.innerHTML = content
            }
            // parse stroke information
            // if (type === "paths") {
            //     console.log(content);
            // }
        };

        const sendPrompt = (e) => {
            var input = document.getElementById("messageText")
            const msg = JSON.stringify({
                "type": "message",
                "content": input.value
            })
            ws.send(msg);
            input.value = ''
            e.preventDefault()
        }

        const sendPaths = (svgStr) => {
            const msg = JSON.stringify({
                "type": "paths",
                "content": svgStr
            })
            ws.send(msg);
        }

        document.getElementById("send-prompt").addEventListener("submit", (e) => {
            sendPrompt(e)
        })
    </script>
</body>

</html>