<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.15/paper-full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <script src="https://unpkg.com/vanilla-picker@2"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div id="modal">
        <div id="simple-modal">
            <div id="modal-status">
                <h2 id="modal-status">Clearing Canvas</h2>
                <i id="modal-cross" class="fa-solid fa-xmark"></i>
            </div>
            <p>Are you sure you want to delete your drawing? :(</p>
            <div id="action">
                <button id="cancel-modal">Cancel</button>
                <button id="confirm-modal" confirm-action>Confirm</button>
            </div>
        </div>
    </div>

    <div id="sliding-overlay">
        <div id="hero-content">
            <h2>Welcome to Clip draw!</h2>
            <button id="begin">BEGIN</button>
        </div>
    </div>


    <div id="contain-canvas">
        <canvas id="canvas" resize></canvas>
    </div>
    <div id="control-panel">
        <h2 id="message">Input Prompt</h2>
        <form id="send-prompt">
            <input type="text" id="messageText" />
            <button>Send</button>
        </form>
        <div id="slider-controls">
            <div id="color-picker"></div>
            <div id="prompt-input">
                <input type="range" id="width-slider" value="20" min="1" max="40">
                <label>Width</label>
            </div>
        </div>
    </div>

    <div id="button-panel">
        <i class="fa-solid fa-pen fa-fw pen-mode" id="pen" value="pen"></i>
        <i class="fa-solid fa-arrow-pointer fa-fw pen-mode" id="select" value="select"></i>
        <i class="fa-solid fa-eraser fa-fw pen-mode" id="erase" value="erase"></i>
        <i class="fa-solid fa-clock-rotate-left fa-fw" id="undo" value="undo"></i>
        <i class="fa-solid fa-rotate-right fa-fw" id="redo" value="undo"></i>
        <i class="fa-solid fa-trash fa-fw" id="delete" value="delete"></i>
    </div>

    <script>
        //     const targetHeight = 224;
        // const scaleFactor = targetHeight / window.innerHeight; // scale as a square, innerHeight smaller than width
        const modal = document.getElementById("modal");
        const canvas = document.getElementById('canvas');
        canvas.style.background = "#F4F4F4";

        paper.setup(canvas);
        let strokeColor = "#402f95";
        let strokeWidth = 20;
        let myPath;
        let penMode = "pen";
        let currentSelectedPath;
        undoStack = [];
        redoStack = [];
        // undoStack.push({"type": 'addPath', 'id': newPath.id});



        // Drawing Controls
        document.querySelectorAll(".pen-mode").forEach(elem => {
            elem.addEventListener("click", () => {
                penMode = elem.id;
                console.log(penMode)
            });
        });

        const tool = new paper.Tool();
        tool.onMouseDown = function(event) {
            if (penMode === "select") {
                segment = path = null;
                var hitResult = paper.project.hitTest(event.point, {
                    segments: true,
                    stroke: true,
                    // fill: true,
                    // tolerance: 5
                });
                if (!hitResult) {
                    currentSelectedPath.selected = false;
                    currentSelectedPath = null;
                    return;
                }
                // if (event.modifiers.shift) {
                //     if (hitResult.type == 'segment') {
                //         hitResult.segment.remove();
                //     };
                //     return;
                // }
                if (hitResult) {
                    path = hitResult.item;
                    path.selected = true;
                    if (currentSelectedPath) {
                        currentSelectedPath.selected = false;
                    }
                    currentSelectedPath = path;
                    console.log(hitResult);
                    // if (hitResult.type == 'segment') {
                    //     segment = hitResult.segment;
                    // } else if (hitResult.type == 'stroke') {
                    //     var location = hitResult.location;
                    //     segment = path.insert(location.index + 1, event.point);
                    //     path.smooth();
                    // }
                }
            }
            if (penMode === "pen") {
                myPath = new paper.Path({
                    strokeColor: strokeColor,
                    strokeWidth: strokeWidth,
                    strokeCap: 'round',
                    strokeJoin: 'round'
                });
                myPath.add(event.point);
                myPath.add({
                    ...event.point,
                    x: event.point.x + .001 //this is ok because path gets simplified
                }); //in case no drag means no line segment
            }
        }
        tool.onMouseDrag = function(event) {
            // if (penMode === "select") {
            //     if (currentSelectedPath) {
            //         console.log(currentSelectedPath)
            //         currentSelectedPath.position += event.delta;
            //     }
            // }
            if (penMode === "pen") {
                myPath.add(event.point);
                myPath.smooth();
            }
        }
        tool.onMouseUp = function(event) {
            if (penMode === "pen") {
                myPath.simplify()
                console.log(myPath)
                console.log(paper.project.exportSVG());
                // myPath.selected = true;
                // myPath.selected = true;
                // const pathStrokes = myPath.exportSVG();
                // console.log(myPath.pathData);
                sendPaths(paper.project.exportSVG({
                    asString: true
                }));
                // console.log(paper.project.getItems()[0]._children); // is an array of paths and can get segments or pathData
                // paper.project.importSVG(svg)
                // console.log(svg)
                //draw path
                // var pathData = 'm 54.473683,133.57894 c 2.309053,6.52389 5.103384,12.88691 9.947368,18.00001 1.602465,1.69148 7.516862,3.36572 9,3.78947 8.215344,2.34724 20.231724,5.06339 28.894739,2.8421 3.21552,-0.82449 6.03091,-2.77861 9,-4.26315 8.27335,-4.13668 15.89845,-8.52099 21.31579,-16.10527';
                // var path = new paper.Path(pathData);
                // path.strokeColor = 'red';
                // path.scale(5);
            }
        }
        document.body.addEventListener('keydown', function(event) {
            if (event.keyCode == 8) {
                deletePath();
                event.preventDefault();
            }
            if (event.keyCode == 46) {
                deletePath();
                event.preventDefault();

            }
        });

        const deletePath = () => {
            if (currentSelectedPath) {
                currentSelectedPath.remove();
            }
            // also push p
            event.preventDefault();
        }

        const undo = () => {
            // pop off last path and push it onto undo stack.
            // if redo just pop off undo stack.
        }

        // Color picker
        const picker = new Picker({
            parent: document.getElementById("color-picker"),
            popup: false,
            alpha: true,
            defaultColor: '#0cf',
            editor: false,
            editorFormat: 'hex' // or 'rgb', 'hsl'
        });
        picker.setColor("#402f95");
        picker.onChange = (color) => {
            strokeColor = color.rgbaString;
        };
        document.getElementById("width-slider").oninput = function() {
            strokeWidth = parseInt(this.value, 10);
        }


        const ws = new WebSocket('ws://localhost:8000/ws');
        ws.onmessage = function(event) {
            console.log(event)
            const message = document.getElementById('message');
            const {
                type,
                content
            } = JSON.parse(event.data);
            if (type === "message") {
                message.innerHTML = content
            }
            // parse stroke information
            // if (type === "paths") {
            //     console.log(content);
            // }
        };

        const sendPrompt = (e) => {
            var input = document.getElementById("messageText")
            const msg = JSON.stringify({
                "type": "message",
                "content": input.value
            })
            ws.send(msg);
            input.value = ''
            e.preventDefault()
        }

        const sendPaths = (svgStr) => {
            const msg = JSON.stringify({
                "type": "paths",
                "content": svgStr
            })
            ws.send(msg);
        }

        document.getElementById("send-prompt").addEventListener("submit", (e) => {
            sendPrompt(e)
        })
        document.getElementById("begin").addEventListener("click", () => {
            document.getElementById("sliding-overlay").style.bottom = "100%";
        });
        document.getElementById("delete").addEventListener("click", () => {
            modal.style.display = "block";
        });
        document.getElementById("cancel-modal").addEventListener("click", () => {
            modal.style.display = "none";
        });
        document.getElementById("modal-cross").addEventListener("click", () => {
            modal.style.display = "none";
        });
        document.getElementById("confirm-modal").addEventListener("click", () => {
            paper.project.clear()
            modal.style.display = "none";
        });
    </script>
</body>

</html>